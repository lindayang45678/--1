/* 获取店主信息 */
$(function(){
	var data = {"id":shopId};
	var resultJson = ajaxCommon(urlShopInfo, data);
	resultJson = convertNullToEmpty(resultJson);
	
	if(resultJson._ReturnCode === returnCodeSuccess) {
		var _ReturnData = resultJson._ReturnData;
		$("#shopname").html("").html(_ReturnData.shopname);
	}else{
		//接口返回错误
	}
});

/*初始化iScroll*/
var indexScroll;
function scrollIndex() {
	indexScroll = new iScroll("index-left",{hScrollbar:false, vScrollbar:false,checkDOMChanges:true});
}

//右侧商品iScroll
var rightScroll;
function scrollRight(){
	rightScroll = new iScroll("index-content",{hScrollbar:false, vScrollbar:false,checkDOMChanges:true});
}

/*根据浏览器的高度计算iScroll的高度以及相应的块高度*/
$(function() {
	var sHeight = storage.getItem("windowHeight");
	$("#index-left").css("height", sHeight-$("header").height()-$(".shopindex-part1").height()-$(".index-add").height());
	$('#index-content').css("height", sHeight-$("header").height()-$(".shopindex-part1").height()-$(".index-add").height());
	$('.index-404').css("height",screen.availHeight-$('header').height()-$('.shopindex-part1').height()-$('.index-add').height());
});

/* 小店管理获取本店左侧菜单 */
var objvirtualid = {id:""};//以此id获取右侧商品
var objid = objvirtualid.id;
$(function() {
	scrollIndex();
	$("#index-left a").live("tap", function(event) {
		$("#index-left").find("a").removeClass("bgwhite").find("i").removeClass("red-icon"); //去掉所有选中样式
		$(this).addClass("bgwhite").find("i").addClass("red-icon"); //添加当前选中样式
		if($(this).siblings("ul").hasClass("hidden")) {
			$(this).siblings("ul").removeClass("hidden");
			indexScroll.refresh();
		} else {
			$(this).siblings("ul").addClass("hidden");
			$(this).parent().find("ul").addClass("hidden");
			if($(this).siblings("ul").length != 0) {
				$(this).removeClass("bgwhite").find("i").removeClass("red-icon"); //去掉当前选中样式
			}
			indexScroll.refresh();
		}
		$(this).parent().siblings("li").find("a").siblings("ul").addClass("hidden"); //同级隐藏
		var objcatid = $(this).attr("catid");
		objid = objcatid;
		$(".content1").html("");
		session.setItem("level",$(this).attr("level"));
		sideshopgoodslist(objid);
		event.stopPropagation(event);
	});
	indexScroll.refresh();

	//左侧商品点击事件
	eleBindEvent();
});

/* 小店管理获取本店左侧分类 */
$(function(){
	var data = {"token":userToken, "psam":psam};
	var container = $("#index-left ul");
	var content = "";
	var resultJson = ajaxCommon(urlQueryVircateByGoods, data);
	resultJson = convertNullToEmpty(resultJson);
	if (resultJson._ReturnCode === returnCodeSuccess) {
		content += "<li><a href='javascript:;' catid='new' level='first'>最新上架<i></i></a></li>";
		$('.index-404').hide();
		var _returnData = resultJson._ReturnData;
		if(_returnData.length > 0){
			$('.index-404').hide();
			for(var i = 0; i < _returnData.length; i ++){
				var firstCate = _returnData[i];//一级虚拟分类
				var firstfather = firstCate.fatherVirtualCateId; //一级虚拟分类父ID
				var firstId = firstCate.tVirtualCateId;//一级虚拟分类ID
				var firstDisc = firstCate.virtualCateDisc;//一级虚拟分类名称
				if(firstfather == 0){
					content += "<li>";
					content += "<a href='javascript:;' catid=" +firstId+ " level='first'>" +firstDisc+ "<i></i></a>";
					content += "<ul class='index-menu2 hidden'>";
					for(var j = 0;j < _returnData.length; j ++){
						var secondCate = _returnData[j]; //二级虚拟分类
						var secondfather = secondCate.fatherVirtualCateId; //二级虚拟分类父ID
						var secondId = secondCate.tVirtualCateId; //二级虚拟分类ID
						var secondDisc = secondCate.virtualCateDisc;//二级虚拟分类名称
						if(secondfather == firstId){
							content += "<li>";
							content += "<a href='javascript:;' catid=" +secondId+ " level='second'>" +secondDisc+ "<i></i></a>";
							content += "<ul class='index-menu3 hidden'>";
							for(var k = 0; k < _returnData.length; k ++){
								var thirdCate = _returnData[k];//三级虚拟分类
								var thirdfather = thirdCate.fatherVirtualCateId//三级虚拟分类父ID
								var thirdId = thirdCate.tVirtualCateId;//三级虚拟分类ID
								var thirdDisc = thirdCate.virtualCateDisc;//三级虚拟分类名称
								if(thirdfather == secondId){
									content += "<li>";
									content += "<a href='javascript:;' catid=" +thirdId+ " level='third'>" +thirdDisc+ "<i></i></a>";
									content += "<ul class='index-menu4 hidden'>";
									for(var l = 0; l < _returnData.length; l ++){
										var fourthCate = _returnData[l];//四级虚拟分类
										var fourthfather = fourthCate.fatherVirtualCateId//四级虚拟分类父ID
										var fourthId = fourthCate.tVirtualCateId;//四级虚拟分类ID
										var fourthDisc = fourthCate.virtualCateDisc;//四级虚拟分类名称
										if(fourthfather == thirdId){
											content += "<li>";
											content += "<a href='javascript:;' catid=" +fourthId+ " level='fourth'>" +fourthDisc+ "<i></i></a>";
											content += "</li>";
										}
									}
									content += "</ul>";
									content += "</li>";
								}
							}
							content += "</ul>";
							content += "</li>";
						}
					}
					content += "</ul>";
					content += "</li>";
				}
			}
			container.html("").append(content);
			indexScroll.refresh();
			
			var firstCatId = $(".index-menu1 li").eq("0").find("a").eq("0");
			scrollRight();
			sideshopgoodslist(firstCatId.attr("catid"));
			var firstCatId = $(".index-menu1 li").eq("0").find("a").eq("0");
			firstCatId.addClass("bgwhite").find("i").addClass("red-icon");
			firstCatId.siblings("ul").removeClass("hidden");
		} else {
			//小店管理获取本店无左侧分类
			$(".index-menus").hide();
			$('.index-404').show();
		}
	}else{
		//接口返回错误_ReturnMsg
		$(".index-menus").hide();
		$('.index-404').show();
	}
})

/* 小店管理获取本店 右侧商品 */
var type = 0;
function sideshopgoodslist(objid) {
	var goodcontainer = $(".content1");
	var ret = "";
	var level = session.getItem("level") || "first";
	var data = {"psam":psam, "channelid":channelcode2C, "virtualcatid":objid, "type":type,"level":level};
	var resultJson = ajaxCommon(urlsideshopgoodslist, data);
	resultJson = convertNullToEmpty(resultJson);
	if (resultJson._ReturnCode === returnCodeSuccess) {
		var _ReturnData = resultJson._ReturnData;
		if(objid == "all") {
			var count = _ReturnData.count;
			$("#count").text("(" + count + "个)");
		}
		var goodList = _ReturnData.list;
		if(goodList.length > 0){
			$("p.no-shopgoods").addClass("hidden");
			for(var i = 0; i <goodList.length; i ++) {
				var saleflag = goodList[i].saleflag; //上下架标识--0：上架，1：下架
				var oneksyupload = goodList[i].oneksyupload;  //一键上传标识--0：非一键上传，1：一键上传
				var freshgoodsflag = goodList[i].freshgoodsflag;  //生鲜标识--0：非生鲜，1：生鲜
				var tgoodinfoid = goodList[i].tgoodinfoid;
				if(typeof(goodList[i].tGoodInfoPoolId)!="undefined" && goodList[i].tGoodInfoPoolId!="") {
					tgoodinfoid = goodList[i].tGoodInfoPoolId;
				}
				ret +=	"<li tgoodinfoid=" + goodList[i].tgoodinfoid + ">";
				ret +=		"<a href='javascript:;' class='goods'>";
				ret +=			"<dl>";
				ret +=				"<dt><img src='" + urlImage + "/" + tgoodinfoid + "/" + imgw100 + "/" + goodList[i].goodbigpic.split(";")[0] + "' onerror='productErrImg(this);'/></dt>";
				ret +=				"<dd>";
				ret +=					"<h3>" + goodList[i].goodname + "</h3>";
				//非生鲜商品，不显示库存
				if(freshgoodsflag == 1) {
					ret += "<div class='num'>库存：<span>" + goodList[i].store + "</span>销量：<span>" + goodList[i].soldstore + "</span></div>";
				} else {
					ret += "<div class='num'>销量：<span>" + goodList[i].soldstore + "</span></div>";
				}
				ret +=       			"<div class='price'><span>¥" + goodList[i].saleprice_o2o + "</span></div>"
				ret +=				"</dd>";
				ret +=			"</dl>";
				ret +=		"</a>";
				if(saleflag == 0 ) {
					ret +=	"<a href='javascript:;' class='unshelve common'>下架</a>";
				} else {
					ret +=	"<a href='javascript:;' class='common done'>已下架</a>";
				}
				ret +=	"</li>";
			}
			goodcontainer.append(ret);
			$(".done").parent().addClass("unlink");
			$('.unshelve').on('tap',function(event) {
				if($(this).hasClass("done")) {
					return;
				}
				var tGoodsInfoId = $(this).parent().attr('tgoodinfoid');
				var thisLi = $(this).parent();
				var thiscontent = thisLi.html();
				event.stopPropagation();
				event.preventDefault();
				$('#unshelf-pop').removeClass('hidden');
				$('#unshelf-cancel').on('tap',function(event) {
					$('#unshelf-pop').addClass('hidden');
					$('#unshelf-cancel').unbind();
					event.stopPropagation();
					event.preventDefault();
				});
				$('#unshelf-confirm').on('tap',function(event) {
					$('#unshelf-pop').addClass('hidden');
					$('#unshelf-confirm').unbind();
					event.preventDefault();
					var upshelfdate = {"token":userToken, "mobile":mobile, "opt":209, "goodsIdList[0]":tGoodsInfoId}
					var downShelfJson = ajaxCommon(urlUpShelf, upshelfdate);
					if(downShelfJson._ReturnCode === returnCodeSuccess) {
						showAlertMsg(msgDownShelf);
						if($(".index-menu1 li a").eq(0).hasClass("bgwhite")) {
							//最新上架 列表中不显示已下架商品
							thisLi.remove();
						} else {
							thisLi.addClass("unlink");
							thisLi.find(".unshelve").remove();
							thisLi.append("<a href='javascript:;' class='common done'>已下架</a>");
						}
					} else {
						showAlertMsg(msgDownShelfFail);
					}
				});	
			});
			rightScroll.refresh();
		}else{
			if(objid == "new") {
				$(".index-menu1 li").eq("0").hide();
				var firstCatId = $(".index-menu1 li").eq("1").find("a").eq("0");
				scrollRight();
				sideshopgoodslist(firstCatId.attr("catid"));
				var firstCatId = $(".index-menu1 li").eq("1").find("a").eq("0");
				firstCatId.addClass("bgwhite").find("i").addClass("red-icon");
				firstCatId.siblings("ul").removeClass("hidden");
			} else {
				$("p.no-shopgoods").removeClass("hidden");//没有获取到商品
			}
		}
	} else {
		//小店管理获取本店商品失败
		$('.index-404').show();
	}
}

/**
 * 元素的事件绑定
 */
function eleBindEvent() {
	$("#index-content li a").live("click", function() {
		if(!$(this).hasClass("unshelve")) {
			var tGoodsInfoId = $(this).parent().attr("tgoodinfoid");
			window.location.href = "editgoods1.html?tGoodsInfoId=" + tGoodsInfoId + "&t=" + t;
		}
	});
}