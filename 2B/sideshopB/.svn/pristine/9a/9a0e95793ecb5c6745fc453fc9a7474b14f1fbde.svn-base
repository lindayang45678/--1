$(function(){
	var sUrl = window.location.href;
	var torderproviderid = getParamValueByName(sUrl, "torderproviderid");
	var data = {ecnetno:netNo,torderproviderid:torderproviderid};//两级订单详情
	var resultJson = ajaxCommon(urlOrderView,data);
	resultJson = convertNullToEmpty(resultJson);
	var _ReturnDataInfo = resultJson._ReturnData.orderproviderqueryinfo;//订单信息
	var orderitemslist = _ReturnDataInfo.orderitemslist;//商品列表
	var actualamount = (_ReturnDataInfo.actualamount+_ReturnDataInfo.logiscalfee)-_ReturnDataInfo.favorrulemoney;//实付金额
	var orderdatequeue = resultJson._ReturnData.orderproviderqueryinfo.orderdatequeue;//时间轴
	if(resultJson._ReturnCode === returnCodeSuccess){
		$(".goods-receipt strong").text(_ReturnDataInfo.cusname.split("(")[0]);//收货人
		$(".goods-receipt .fr").text(_ReturnDataInfo.custelno);//收货人电话
		$(".goods-receipt em").text(_ReturnDataInfo.addressfull);//收货人地址
		$(".order-status span em").text(_ReturnDataInfo.torderproviderid);//订单号
		//订单状态时间轴
		var statuscontent = $(".order-status ul");
		var ret = "";
		//配送各个状态的时间列表
		function orderdate(msg,objorderdate){
			ret += "<li>"
			ret += "<s></s>"
			ret += "<p><i>"+ msg +"</i><br/><span>"+ getLocalTime(objorderdate) +"</span></p>";
			ret += "</li>";
			return ret;
		}
		if(orderdatequeue.qssj != ""){
			orderdate(msgTimelineSign,orderdatequeue.qssj)
		}
		if(orderdatequeue.fhsj != ""){
			orderdate(msgTimelineShipped,orderdatequeue.fhsj);
		}
		if(orderdatequeue.zfsj != ""){
			orderdate(msgTimelinePaymented,orderdatequeue.zfsj);
		}
		if(orderdatequeue.xdsj != ""){
			orderdate(msgTimelineSubmited,orderdatequeue.xdsj);
		}
		statuscontent.prepend(ret);
		$(".order-status ul li:first-child").addClass("active");
		$(".orders-list h3 span").text(_ReturnDataInfo.providername);//供应商名称
		$(".orders-list .fr s").text(_ReturnDataInfo.clientservicetel);//供应商售后电话
		//商品信息列表
		var goodscontent = $(".orders-list li");
		var goodsret ="";
		if(orderitemslist.length > 0){
			for(var j = 0; j < orderitemslist.length; j++) {
				var goodbigpic = orderitemslist[j].goodbigpic;//商品图片
				var goodsid = orderitemslist[j].goodsid;//商品id
				goodsret += "<dl class='goods'>";
				goodsret += "<dt><img src='" +urlImage + "/" + goodsid + "/" + imgw100 + "/" + goodbigpic.split(";")[0] + "' /></dt>";
				goodsret += "<dd>";
				goodsret += "<span class='title'><i class='c-black'>" + orderitemslist[j].goodsname + "</i><u class='nobr'>" + orderitemslist[j].norms + "</u></span>";
				goodsret += "<span class='total'><i class='c-black'>¥" + orderitemslist[j].goodssaleprice + "</i><u>x" + orderitemslist[j].goodscount + "</u></span>";
				goodsret += "</dd>";
				goodsret += "</dl>"; 
			}
			goodscontent.append(goodsret);
			
			//查看物流属性绑定
			$("#ckwl").attr("logno",orderitemslist[0].logisticscode)
			.attr("state",orderitemslist[0].state)
			.attr("orderitemsid",orderitemslist[0].torderitemsid);
			//全部收货属性绑定
			$("#qbsh").attr("torderproviderid",torderproviderid)
			.attr("logno",orderitemslist[0].logisticscode);
			//店主收货属性绑定
			$("#dzsh").attr("logno",orderitemslist[0].logisticscode);
		}
		$(".fee p:nth-child(1) span").html("-¥"+_ReturnDataInfo.favorrulemoney);//优惠金额
		$(".fee p:nth-child(2) span").html("¥"+_ReturnDataInfo.logiscalfee);//运费
		$(".fee p:nth-child(3) span").html("¥"+actualamount);//实付金额
		
		//根据供应商订单状态显示按钮
		var state = _ReturnDataInfo.state;
		//配送中（部分发货：101，已发货：102）
		if(parseInt(state) == stateBFFH || parseInt(state) == stateYFH) {
			$("#dzsh").removeClass("hidden");
			$("#ckwl").removeClass("hidden");
		}
		//部分收货（部分签收：103）
		if(parseInt(state) == stateBFQS) {
			$("#qbsh").removeClass("hidden");
			$("#ckwl").removeClass("hidden");
		}
		//已签收（已签收：104）
		if(parseInt(state) == stateYQS){
			$("#zcgm").removeClass("hidden");
			$("#ckwl").removeClass("hidden");
		}
	} else {
		showAlertMsg(resultJson._ReturnMsg);
	}
});

/* 查看物流*/
$("#ckwl").on("tap", function(){
	var logno = $(this).attr("logno");
	var state = $(this).attr("state");
	var orderitemsid = $(this).attr("orderitemsid");
	directDeliveryHtml(logno,state,orderitemsid);
});

/* 店主收货*/
$("#dzsh").on("tap", function(){
	var logno = $(this).attr("logno");
	var data = {"logno":logno,"netno":netNo};
	var resultJson = ajaxCommon(urlreceipt, data);
	if(resultJson._ReturnCode === returnCodeSuccess) {
		resultJson = JSON.stringify(resultJson);
		storage.setItem("shopReceiptQuery",resultJson);
		window.location.href = "../receipt/shopreceiptinfo.html?logno="+ logno +"&t=" + t;	
	}
	else {
		window.location.href = "../receipt/shopreceiptfail.html?logno="+ logno +"&t=" + t;
	}	
});

/* 店主全部收货*/
$("#qbsh").on("tap",function(){
	$(".pop-up-box").removeClass("hidden");
});

$("#receipt-confirm").on("tap",function(){
	var logno = $(this).attr("logno"); 
	var orderproviderid = $("#qbsh").attr("torderproviderid");
	var data = {"orderproviderid":orderproviderid};
	var resultJson = ajaxCommon(urlConfirmShAll,data);
	resultJson = convertNullToEmpty(resultJson);
	$(".pop-up-box").hide();
	if(resultJson._ReturnCode === returnCodeSuccess){
		showAlertMsg(msgOrderAllSigned);
		window.location.href = "ordersdetail.html?torderproviderid=" +orderproviderid;
	}else{
		showAlertMsg(resultJson._ReturnMsg);
	}
});

$("#receipt-cancel").on("tap",function(){
	$(".pop-up-box").addClass("hidden");
});